name: "CodeQL 進階安全掃描"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
  merge_group:
    types: [checks_requested]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1' # 每週一定時掃描

permissions: {}

jobs:
  analyze:
    name: 分析 (Python)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    steps:
    - name: 檢出儲存庫
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

    # --- 針對 uv 的設定區塊 ---
    - name: 安裝 uv
      uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86
      with:
        enable-cache: true

    - name: 設定 Python 環境 (使用 uv)
      run: uv python install

    - name: 安裝專案依賴 (增強 CodeQL 分析準確度)
      run: uv sync
    # -----------------------

    - name: 初始化 CodeQL
      uses: github/codeql-action/init@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2
      with:
        languages: python
        build-mode: none
        # 僅保留設定檔引用，細節交給 config-file 處理
        config-file: .github/codeql/codeql-config.yml

    - name: 執行 CodeQL 分析
      uses: github/codeql-action/analyze@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2
      with:
        category: "/language:python"